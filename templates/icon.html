<!DOCTYPE html>
<html>
<head>
    <title>{{ icon.title }} - Iconostasis</title>
    <link rel="stylesheet" type="text/css" href="/static/css/style.css?v=4"> 
    <link rel="icon" href="/static/images/favicon.ico" type="image/x-icon">
</head>
<body>

<div class="navbar">
    <div class="nav-left">
        <h2 class="site-title">Iconostasis</h2>
        <a href="/">Home</a>
        <a href="/upload">Upload</a>
    </div>

    <div class="nav-right">
        {% if user %}
            <div class="username-display"> 
                Logged in as <a href="/user/{{ user.username }}" style="font-weight: bold;">{{ user.display_name }}</a>
            </div>
            <a href="/logout">Logout</a>
        {% else %}
            <a href="/login">Login</a>
            <a href="/signup">Register</a>
        {% endif %}
    </div>
</div>


<div class="container">
    <!-- Sidebar -->
    <aside id="sidebar" class="sidebar">
        <button id="sidebarToggle" class="toggle-btn">‚ò∞</button>
        <div class="sidebar-content">
            <h3>Icon Details</h3>
            <p><strong>Title:</strong> {{ icon.title }}</p>
            <p><strong>Saint(s):</strong> 
                {% for saint in icon.saints %}
                    <a href="/?saint={{saint.name}}">{{ saint.name }}{% if not loop.last %}, {% endif %}</a>
            {% endfor %}
        </p>
        <p><strong>Tradition:</strong> <a href="/?tradition_id={{ icon.tradition.id }}">{{ icon.tradition.name }}</p></a>
        <p><strong>Century:</strong> <a href="/?century={{ icon.century }}"> {{ icon.century }}</p></a>
        <p><strong>Region:</strong> <a href="/?region={{ icon.region }}"> {{ icon.region }}</p></a>
        <p><strong>Iconographer:</strong> {{ icon.iconographer or "Unknown" }}</p>
        <p><strong>Uploaded by:</strong> <a href="/user/{{ icon.creator.username }}">{{uploader_name}}</p></a>
    </aside>

    <!-- Main content -->
        <div class="icon-main">

            <div class="icon-detail">
                <img class="icon-img" src="{{ icon.image_url }}" alt="{{ icon.title }}">
                <div class="icon-description">
                    <h2>Description</h2>
                    <p>{{ icon.description }}</p>
                </div>
            </div>

            <div id="interaction-wrapper" class="interaction-wrapper">

                <section class="candle-section">
                    <button id="candle-button" 
                            class="{% if user in icon.venerators %}candle-active{% endif %}"
                            onclick="toggleCandle( {{ icon.id }} )">
                        <span id="candle-icon">üïØÔ∏è</span> 
                        <span id="veneration-count">{{ icon.venerators|length }}</span>
                    </button>
                </section>

                <section class="comments-container">
                    <h3 class="section-title">Reflections ({{ icon.comments|length }})</h3>

                    {% if user %}
                    <form action="/icon/{{ icon.id }}/comment" method="POST" class="comment-form">
                        <textarea id="comment-text" name="text" maxlength="1000" placeholder="Share a reflection or prayer..." required></textarea>
                        <div class="counter-container">
                            <span id="char-count">1000</span> characters remaining
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="btn-primary">Post Reflection</button>
                        </div>
                    </form>
                    {% endif %}

                    <br><br>

                    <div class="comments-list">
                        {% for comment in icon.comments|sort(attribute='created_at', reverse=True) %}
                        <div class="comment-card">
                            <div class="comment-header">
                                <a href="/user/{{ comment.author.username }}" class="comment-author">
                                    {{ comment.author.display_name }}
                                </a>
                                <span class="comment-date">
                                    {{ comment.created_at.strftime('%b %d, %Y') }}
                                </span>
                            </div>
                            
                            <div class="comment-body">
                                {{ comment.text }}
                            </div>

                            {% if user and (user.id == comment.user_id or user.is_admin) %}
                            <div class="comment-actions">
                                <a href="/comment/{{ comment.id }}/edit" class="action-link">Edit</a>
                                <form action="/comment/{{ comment.id }}/delete" method="POST" onsubmit="return confirm('Delete this reflection?');">
                                    <button type="submit" class="action-link delete-text">Delete</button>
                                </form>
                            </div>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>

                </section>
            </div>

        </div>
    </div>

<script src="/static/js/sidebar.js"></script>
<script src="/static/js/icons.js"></script>

</body>
</html>

